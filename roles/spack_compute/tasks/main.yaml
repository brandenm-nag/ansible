---

- name: Spack config compiler
  command: /mnt/shared/spack/bin/spack compiler find --scope=system

- name: Spack config externals
  command: /mnt/shared/spack/bin/spack external find --scope=system --not-buildable
  when:
    ansible_local.citc.csp != "aws"

- name: Spack config externals (aws)
  command: /mnt/shared/spack/bin/spack external find --scope=system --not-buildable
  environment:
    PATH: "/opt/amazon/openmpi/bin:{{ ansible_env.PATH }}"
  when:
    ansible_local.citc.csp == "aws"

- name: Spack mark GCC as buildable
  command: /mnt/shared/spack/bin/spack config --scope system add packages:gcc:buildable:true

- name: Spack mark cmake as buildable
  command: /mnt/shared/spack/bin/spack config --scope system add packages:cmake:buildable:true

- name: Build GCC 10
  command: /mnt/shared/spack/bin/spack install gcc@10.2.0 +binutils arch={{ ansible_architecture }}
  become_user: citc

- name: Find GCC 10
  command: /mnt/shared/spack/bin/spack location -i gcc@10.2.0 arch={{ ansible_architecture }}
  register: spack_gcc10_dir

- name: Register new GCC with Spack
  command: /mnt/shared/spack/bin/spack compiler find {{ spack_gcc10_dir }}

- name:  Default new GCC
  command: /mnt/shared/spack/bin/spack config --scope system add "packages:all:compiler:[gcc@10.2.0 arch={{ansible_architecture}}]"

- name: Add Spack to default shells
  copy:
    dest: /etc/profile.d/99-spack.sh
    content: |
      . /mnt/shared/spack/share/spack/setup-env.sh
    owner: root
    mode: u=rwx,g=rx,o=rx
    force: no
